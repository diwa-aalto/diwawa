{% extends "base.html" %}
{% load ip_tools %}
{% block javascript %}
$(document).ready(function(){
	$(document).ajaxSend(function(event, xhr, settings) {
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    function sameOrigin(url) {
        // url could be relative or scheme relative or absolute
        var host = document.location.host; // host + port
        var protocol = document.location.protocol;
        var sr_origin = '//' + host;
        var origin = protocol + sr_origin;
        // Allow absolute or scheme relative URLs to same origin
        return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
            (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
            // or any other URL that isn't scheme relative or absolute i.e relative.
            !(/^(\/\/|http:|https:).*/.test(url));
    }
    function safeMethod(method) {
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    if (!safeMethod(settings.type) && sameOrigin(settings.url)) {
        xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
    }
	});
	//var dropbox = document.getElementById("orange");
	//var download = document.getElementById("green");
	//var temp = document.getElementById("purple");
	var result = document.getElementById('result');
	// init event handlers
	{% for node in node_list %}
	//var node{{node.node.wos_id}}= document.getElementById("node{{node.node.wos_id}}");
	//node{{node.node.wos_id}}.addEventListener("dragenter", noopHandler, false);
	//node{{node.node.wos_id}}.addEventListener("dragexit", noopHandler, false);
	//node{{node.node.wos_id}}.addEventListener("dragover", noopHandler, false);
 	//node{{node.node.wos_id}}.addEventListener("drop", drop, false);
	//node{{node.node.wos_id}}.addEventListener("click",function(){
	//window.open("http://{{node.node.ip|long2ip}}:5800");
	//},false)
	//$('#node{{node.node.wos_id}}').css("background-image", "url({{node.img}})");
	{% endfor %}
	{% if activity.project %}
 	
    //$('#chat_error').hide();
    //if($.cookie('dchat_name') != null){
    //$('#fchat').hide();	
    //init_chat({{chat_id}}, "chat");
    //}
    {% else %}
    $('#project_folder').hide();
    $('#fchat').hide();
    {% endif %}
    $("#fchat").submit(function() {  
    var name =  $("input#name").val();
    $.cookie('dchat_name',name);
    init_chat({{chat_id}}, "chat");
    $('#fchat').fadeOut(300,function(){$('#chat').fadeIn(300,function(){ 
    var ch = $('#chat_container').height()+20;
    var oh = $('.orange_box').height();
    if (ch>oh){ 
    	$('.orange_box').animate({height:ch}); 
    }});});
  
    
    return false;
  });
  $('.orange_box').equalHeights();
  $('#node_holder').tooltip({'position':{ my: "center center", at: "center bottom", collision: "flipfit" }});
  refresh_nodes();  
  refresh_activity();
  $('#eventbtn').button().dropdown('attach', '#dropdown-1').dropdown('disable').bind("contextmenu",function(e){
   $(this).dropdown('enable');
   $(this).click();
   $(this).dropdown('disable');
   return false;
}).mousedown(function(e) {
    if (e.which === 1) {
    	console.log('Left click event');
    	$(this).removeClass('ui-state-hover');
    	add_event();
    	
}
});
$('#dropdown-1 li').click(function(e){
	e.preventDefault();
	e.stopPropagation();
	var id = $(this).attr('id');
	console.log(id);
	if (id != 'custom'){
	var val = $(this).text();
	console.log('Dropdown clicked:'+val);
	add_event(val);
	}
	});
$('#custom_event').keypress(function(e) {
    if(e.which == 13) {
        var value = $(this).val();
        $(this).val('');
        console.log("Input value:"+value);
        add_event(value);
        $('#dropdown-1').hide();
    }
});
  $('#powerbtn').button({
            icons: {
                primary: "ui-icon-power"
            }
       }).click(function(){
       	$.ajax({  
        url: "/awake/",  
        type: "GET",  
        csrfmiddlewaretoken: '{{ csrf_token }}',  
        processData: false,  
        contentType: false,  
        success: function (res) {  
            console.log(res);
        }  
    }); 
       	});
 $("#new_default_event").button().click(function() {
                add_event();
            })
$('#new_custom_event').button({
                    text: false,
                    icons: {
                        primary: "ui-icon-triangle-1-s"
                    }
                }).click(function() {
                    var menu = $('#custom_event_list').show().position({
                        my: "center top",
                        at: "right bottom",
                        of: this
                    });
                    $('#custom_event_list > li >input').one('click',function(e){
                    	e.stopPropagation();
						console.log('input clicked');
                    });
                    $( document ).one( "click", function() {
                        menu.hide();
                    });
                    return false;
                });
                $('#event_buttonset').buttonset();
                $('#custom_event_list').hide().menu();
                $('#snapbtn').button({icons: {primary: "ui-icon-image"}}).click(function(){
                	$.ajax({  
        url: "/snapshot/",  
        type: "GET",  
        csrfmiddlewaretoken: '{{ csrf_token }}',  
        processData: false,  
        contentType: false,  
        success: function (res) {  
            console.log(res);
        }  
    }); 
                });
                $('#screenbtn').button({icons: {primary: "ui-icon-disk"}}).click(function(){
                	$.ajax({  
        url: "/screenshot/",  
        type: "GET",  
        csrfmiddlewaretoken: '{{ csrf_token }}',  
        processData: false,  
        contentType: false,  
        success: function (res) {  
            console.log(res);
        }  
    }); 
                });
 $('#videobtn').button({icons: {primary: "ui-icon-video"}});
 $('#projects').change(function(e){
 var formData = new FormData();
 formData.append('id',$('#projects option:selected').attr('id').split('_')[1]);
 $.ajax({  
        url: "/project/select/",  
        type: "POST",
        data:formData,  
        csrfmiddlewaretoken: '{{ csrf_token }}',  
        processData: false,  
        contentType: false,  
        success: function (res) {  
            console.log(res);
        }  
    });
    $('#filetree').empty();
     });
  
 $( "#chat_btn" ).button({
            icons: {
                primary: "ui-icon-newwin"
            }
       }).click(function(){
       	window.open("/chat/","Chimaira Chat","width=960px,height=600px");
       	});
       	   
   

 });
 function nodes_json(data){
 	$('#node_holder').tooltip('disable');
 	$('#node_holder').empty();
 	$.each(data, function(key, val) {
 	var eid = '#node'+val.node.wos_id;
 	var ip = val.node.ip;
 	var img = val.img;
    $('#node_holder').append('<div class="node" id="node'+val.node.wos_id+'" name="'+val.node.id+'" title="'+val.node.name+'" ip="'+val.node.ip+'"></div>').delay(1000);
  	$(document).off("drop dragenter dragover dragexit click",eid);
  	
    $(document).on("dragenter",eid, noopHandler);
    $(document).on("dragexit",eid, noopHandler);
    $(document).on("dragover",eid, noopHandler);
    $(document).on("drop",eid, drop);
    $(document).on("click",eid,function(e){
    	var ip = num2dot($(this).attr('ip'));
    	
	window.open("http://"+ip+":5800");
	});
	
	$(eid).css("background-image", "url("+val.img+")");
  });
  $('#node_holder').tooltip('enable');
   
 }
  function activity_json(data){
 	if (data.project){
 		if ($('#project_status').text() != data.project.name){
 			$('#project_status').fadeOut(500,function(){$('#project_status').text(data.project.name);$('#project_status').fadeIn(500);});
 		}
 		$('#projects').val(data.project.name).removeAttr('disabled');
 		if($('#filetree').children().size()==0){
 		set_filetree(data.project.dir);
 		$('#filetree').fadeIn(400);
 		}
 		$('#chat_error').hide();
 		$('#fchat').show();
 		if($.cookie('dchat_name') != null){
    	$('#fchat').hide();
    	if($('#chat').children().size()==0){	
    	init_chat(data.room, "chat");
    	}
   }
 	}else{
 		if ($('#project_status').text() != 'None'){
 			
 			$('#project_status').fadeOut(500,function(){$('#project_status').text('None');$('#project_status').fadeIn(500);});
 		}
 		$('#projects').attr('disabled','disabled');
 		$('#filetree').fadeOut(400).empty();
 		$('#fchat').hide();
 		$('#chat_error').show();
 		$('#chat').show();
 	}
 	if(data.session){
		
 		$('#session_status > img').attr('src',"/static/img/accept.png").attr('alt',"Session: ON");
 	}else{
 		$('#session_status > img').attr('src',"/static/img/cancel.png").attr('alt',"Session: OFF");
 	}
 }
 function refresh() {
      window.location.reload(true);
     }
  function refresh_nodes() {
  	  
      $.getJSON('/nodes/',nodes_json);
      setTimeout(refresh_nodes, 10000);
     }
       function refresh_activity() {
      $.getJSON('/activity/',activity_json);
      setTimeout(refresh_activity, 10000);
     }
     function set_filetree(dir){
     	$('#filetree').fileTree({
        root: dir,
        script: '/dirlist/',
    }, function(file) {
        alert(file);
    });
     }
     function num2dot(num) {
var d = num%256;
for (var i = 3; i > 0; i--) {
num = Math.floor(num/256);
d = num%256 + '.' + d;}
return d;}
function hasClass(ele,cls) {
return ele.className.match(new RegExp('(\\s|^)'+cls+'(\\s|$)'));
}
function add_event(title){
	var formData = new FormData();
	if (typeof title != 'undefined'){
	 	formData.append('title',title);
	 }
	 $.ajax({  
        url: "/event/",  
        type: "POST",  
        data: formData,
        csrfmiddlewaretoken: '{{ csrf_token }}',  
        processData: false,  
        contentType: false,  
        success: function (res) {  
            console.log(res);
        }  
    }); 
} 
function addClass(ele,cls) {
if (!this.hasClass(ele,cls)) ele.className += " "+cls;
}
 
function removeClass(ele,cls) {
if (hasClass(ele,cls)) {
var reg = new RegExp('(\\s|^)'+cls+'(\\s|$)');
ele.className=ele.className.replace(reg,' ');
}
}

 	function noopHandler(evt) {
  evt.stopPropagation();
  evt.preventDefault();
  
}
function drag(ev){
ev.dataTransfer.setData("File",ev.target.rel);

}
function dragenter(evt) {
  evt.stopPropagation();
  evt.preventDefault();
  addClass(this,'hover');
}
function dragexit(evt) {
  evt.stopPropagation();
  evt.preventDefault();
  removeClass(this,'hover');
  
}
function valid_url(url){
	if(/^([a-z]([a-z]|\d|\+|-|\.)*):(\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?((\[(|(v[\da-f]{1,}\.(([a-z]|\d|-|\.|_|~)|[!\$&'\(\)\*\+,;=]|:)+))\])|((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=])*)(:\d*)?)(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*|(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)|((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)|((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)){0})(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(url)) {
  return true
} else {
  return false
}

}	
	function drop(evt){
	evt.stopPropagation();
	evt.preventDefault();
	var files = evt.originalEvent.dataTransfer.files;
	var count = files.length;
 	var data=evt.originalEvent.dataTransfer.getData("File");
 	var text = evt.originalEvent.dataTransfer.getData("Text");
 	if (text && valid_url(text) && text.indexOf("{{request.get_host }}") == -1){
 		openURL(text,evt.originalEvent.target.getAttribute("name"));
 	}
	// Only call the handler if 1 or more files was dropped.
	if (count > 0)
		uploadFile(files,evt.originalEvent.target.getAttribute("name"));
	if (data)
		uploadFile(data,evt.originalEvent.target.getAttribute("name"));	
	}
	// upload file
    function uploadFile(files, id, status) {

        // prepare FormData
        var formData = new FormData();
      	if (typeof files == 'string'){
      		formData.append('file', files);
      	}else{
        for(var i=0;i<files.length;i++){
        	formData.append('file'+i, files[i]);
        }}       
         $.ajax({  
        url: "/upload/"+id+"/",  
        type: "POST",  
        data: formData,
        csrfmiddlewaretoken: '{{ csrf_token }}',  
        processData: false,  
        contentType: false,  
        success: function (res) {  
            //document.getElementById("result").innerHTML = res;   
        }  
    });  
    }
    function openURL(url, id, status) {

        // prepare FormData
        var formData = new FormData();    
        formData.append('url',url);
         $.ajax({  
        url: "/openurl/"+id+"/",  
        type: "POST",  
        data: formData,
        csrfmiddlewaretoken: '{{ csrf_token }}',  
        processData: false,  
        contentType: false,  
        success: function (res) {  
            //document.getElementById("result").innerHTML = res;   
        }  
    });  
    }
{% endblock %}

{% block pagetitle %}Chimaira Web Application{% endblock %}

{% block content %}

<div id="node_holder" class="grid_12 alpha omega clearfix purple_box">

<!--
<div class="node grid_3" id="orange" name="2">Orange</div>
<div class="node grid_3" id="green" name="3">Green</div> 
<div class="node grid_3" id="purple" name="4">Purple</div> -->     
</div>

<div id="toolbar" class="ui-widget-header ui-corner-all grid_12 alpha omega">
	<button id="eventbtn" type="button">!</button>
	<div id="event_buttonset">
		<button id="new_default_event" type="button">Event</button>
		<button id="new_custom_event" type="button"></button>
	</div>
	<button id="powerbtn" type="button">Power On!</button>
	<div id="status_info"><span id="session_status"><img src="/static/img/cancel.png"/>Session</span><!--<span id="project_status">None</span>-->
		<select id="projects">
			{% for project in projects %}
				<option id="project_{{project.id}}">{{project.name}}</option>
			{% endfor %}
		</select>
	</div>
	<button id="snapbtn" type="button">Snaphot</button>
	<button id="screenbtn" type="button">Screenshot</button>
	<button id="videobtn" type="button">Video Rec</button>
</div>
	
<div class="grid_4 alpha"><div class="orange_box"><div id="filetree_container"><h3>Project Folder</h3>
<div id="filetree"></div>
</div></div></div>
<div class="grid_4"><div class="orange_box"><div id="chat_container"><h3>Chat</h3><div>
<div id="chat_error" class="error alert-message">
		<p class='notice'> Chat not available!</p>
</div>
<form id="fchat">
	<input id="name" name="name" required type="text" onblur="if (this.value == '') {this.value = 'Enter name here!';}" onfocus="if (this.value == 'Enter name here!') {this.value = '';}" value="Enter name here!">
	<input type="submit" name="submit"  id="chat_submit" value="Go!" /> 
</form>
<button id="chat_btn" type="button">New Window</button>
<div id="chat"></div>
</div></div></div></div>
<div class="grid_4 omega clearfix"><div class="orange_box"><div id="info_container">
	<h3>Info</h3>
	

<p>Features</p>
<ul>
<li>Drag and Drop Files from computer to a node</li>
<li>Show contents of project folder</li>
<li>Drag and Drop Files from project folder to a node</li>
<li>Drag and Drop urls to a node</li>	
<li>Live chat bind to a (selected) project</li>	
<li>Activity: selected project and session status (on/off)</li>
</ul>
<a href="http://www.twiddla.com/NewMeeting.aspx?title=" title="Twiddle this page!" target="_blank" onclick="this.href+=document.title;"><img src="http://img.twiddla.com/images/buttons/twiddle_this_100x20.gif" alt="Twiddle this page!" /></a>
</div></div></div>
<div class="clear"></div>
<!--<p>Now:{% now "jS F Y H:i" %}Nodes:</p>
<ul>
	{% for node in nodes %}
	<li>{{node.name}}-{{node.ip|long2ip}}-{{node.mac}}-{{node.wos_id}}-{{node.time|date:"jS F Y H:i"}}</li>
	{% endfor %}
</ul>-->

<div id="dropdown-1" class="dropdown-menu has-tip">
    <ul>
        <li><a href="#1">Important</a></li>
        <li><a href="#2">Action Point</a></li>
        <li><a href="#3">Something</a></li>
        <li class="divider"></li>
        <li id="custom"><input type="text" id="custom_event"/></li>
    </ul>
</div>
	<ul id="custom_event_list" role=menu>
        <li><a href="#1">Important</a></li>
        <li><a href="#2">Action Point</a></li>
        <li><a href="#3">Something</a></li>
        <li class="divider"></li>
        <li id="custom"><input type="text" id="custom_event"/></li>
    </ul>
    
{% endblock %}
